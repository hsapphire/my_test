# Java 1.8 垃圾回收机制

## 1. 内存结构

JDK8 的堆和方法区结构：

- **堆（Heap）**
  - **新生代（Young Generation）**
    - **Eden 区**：新对象首先分配在这里
    - **Survivor 区（S0 / S1）**：Eden GC 后的幸存对象存放，经过多次 GC 后晋升到老年代
  - **老年代（Old Generation）**
    - 存放生命周期较长的大对象、晋升对象
- **元空间（Metaspace）**
  - 替代了 JDK7 及以前的 **永久代 (PermGen)**
  - 使用 **本地内存**，存储类元数据、方法信息、常量池等

---

## 2. GC 算法

- **标记-清除（Mark-Sweep）**
  - 标记存活对象，再清除未标记对象
  - 问题：会产生内存碎片

- **复制算法（Copying）**
  - 新生代常用
  - 存活对象复制到 Survivor 区，清空 Eden
  - 优点：效率高，无碎片

- **标记-整理（Mark-Compact）**
  - 老年代常用
  - 标记后将存活对象移动到一端，避免碎片

- **分代收集**
  - 新生代：复制算法
  - 老年代：标记-整理
  - 提升效率

---

## 3. 垃圾收集器

Java 8 默认收集器组合：

- **新生代：Parallel Scavenge**
- **老年代：Parallel Old**

常见收集器对比：

| 收集器 | 代 | 算法 | 特点 |
|--------|----|------|------|
| Serial | 新生代 | 复制 | 单线程，适合小堆 |
| Serial Old | 老年代 | 标记-整理 | 单线程 |
| Parallel Scavenge | 新生代 | 复制 | 多线程，吞吐量优先 |
| Parallel Old | 老年代 | 标记-整理 | 多线程，吞吐量优先 |
| CMS | 老年代 | 标记-清除 | 并发收集，低延迟，可能有碎片 |
| G1 | 整堆 | 分区化，标记-整理 | JDK8 引入，低停顿，适合大内存 |

---

## 4. GC 类型与触发条件

- **Minor GC（新生代 GC）**
  - Eden 区满时触发
  - 存活对象复制到 Survivor，部分晋升老年代
  - 停顿时间短，频率高

- **Major GC（老年代 GC）**
  - 老年代不足时触发
  - 使用标记-整理
  - 停顿时间较长

- **Full GC（整堆 GC）**
  - 新生代 + 老年代 + 元空间
  - 触发条件：
    - System.gc() 调用
    - 老年代空间不足
    - 元空间（Metaspace）不足
    - CMS/G1 promotion failed

---

## 5. JDK8 特有变化

- **永久代 (PermGen) 移除** → **元空间 (Metaspace)**
  - 使用本地内存，可通过 `-XX:MaxMetaspaceSize` 设置上限
- **引入 G1 收集器**
  - 替代 CMS，更适合大内存场景
- 默认 GC 策略：**Parallel Scavenge + Parallel Old**

---

## 6. 对象晋升流程

1. 对象首先分配在 Eden
2. Minor GC 后，存活对象进入 Survivor
3. 在 Survivor 中多次存活（年龄阈值，默认 15 次）后晋升到老年代
4. 老年代不足时触发 Major GC
5. 必要时触发 Full GC


# 举例说明
# JDK 1.8 垃圾回收机制示例

## 示例代码

```java
public class GcTest {
    private static final int _1MB = 1024 * 1024;

    public static void main(String[] args) {
        // Step 1: 分配 2MB 对象 → Eden
        byte[] allocation1 = new byte[2 * _1MB];

        // Step 2: 再分配 2MB 对象 → Eden
        byte[] allocation2 = new byte[2 * _1MB];

        // Step 3: 分配 2MB 对象 → Eden
        byte[] allocation3 = new byte[2 * _1MB];

        // Step 4: 再分配 4MB 对象 → Eden 空间不足，触发 Minor GC
        byte[] allocation4 = new byte[4 * _1MB];
    }
}
```

## 运行参数（示例）：
-XX:+PrintGCDetails -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8

## 运行参数解析
堆大小 20M：-Xms20M -Xmx20M
新生代大小 10M：-Xmn10M
Eden:Survivor = 8:1:1 → Eden 8M，Survivor1 1M，Survivor2 1M
老年代 10M
## 执行过程
分配 allocation1 (2MB)
→ 放入 Eden，Eden 剩余 6MB。
分配 allocation2 (2MB)
→ 继续放入 Eden，Eden 剩余 4MB。
分配 allocation3 (2MB)
→ 继续放入 Eden，Eden 剩余 2MB。
分配 allocation4 (4MB)
Eden 空间不足（只有 2MB 可用）
触发 Minor GC：
存活的对象（allocation1、2、3）从 Eden 复制到 Survivor
Survivor 放不下时，直接晋升到老年代
GC 后 allocation4 放入 Eden。
## gc日志
[GC (Allocation Failure) [PSYoungGen: 8192K->992K(9216K)] 
    8192K->7120K(19456K), 0.0056789 secs] 
[Times: user=0.00 sys=0.00, real=0.01 secs]
解释：
新生代 (PSYoungGen) 从 8192K → 992K
整堆从 8192K → 7120K
存活对象被移入老年代

## Mermaid 流程图
flowchart TD
    A[allocation1: 2MB → Eden] --> B[allocation2: 2MB → Eden]
    B --> C[allocation3: 2MB → Eden]
    C --> D[allocation4: 4MB → Eden 空间不足]
    D -->|触发 Minor GC| E[存活对象复制到 Survivor/老年代]
    E --> F[allocation4 放入 Eden]

## 总结
对象优先分配在 Eden 区
Eden 满 → Minor GC，存活对象复制到 Survivor，放不下的晋升老年代
老年代满 → Major GC，回收老年代
Full GC 涉及新生代 + 老年代 + 元空间，最耗时

# Xms Xmx Xmn -XX:SurvivorRatio区别
# JVM 内存参数区别

## 1. `-Xms`
- **含义**：JVM 初始化堆内存大小
- **作用**：JVM 启动时分配的堆内存大小
- **示例**：`-Xms512m` 表示初始堆内存为 512MB
- **特点**：
  - 如果程序需要的堆内存超过 `-Xms`，JVM 会动态扩展到 `-Xmx`
  - 设置过小可能导致频繁扩展，影响性能

---

## 2. `-Xmx`
- **含义**：JVM 最大堆内存大小
- **作用**：JVM 堆内存可以增长的上限
- **示例**：`-Xmx2g` 表示最大堆内存为 2GB
- **特点**：
  - 防止堆内存无限增长导致系统 OOM（OutOfMemoryError）
  - 一般设置大于 `-Xms`，但不能超过物理内存

---

## 3. `-Xmn`
- **含义**：新生代（Young Generation）大小
- **作用**：控制新生代内存大小
- **示例**：`-Xmn256m` 表示新生代大小为 256MB
- **特点**：
  - 新生代由 Eden + Survivor 区组成
  - 适当增大可以减少 Minor GC 次数
  - 如果设置过大，会压缩老年代空间，可能增加 Full GC

---

## 4. `-XX:SurvivorRatio`
- **含义**：Eden 区与 Survivor 区的比例
- **作用**：控制新生代内存中 Eden 与每个 Survivor 区的大小比例
- **示例**：`-XX:SurvivorRatio=8` 表示 Eden : Survivor = 8:1:1
- **特点**：
  - 新生代 = Eden + 2 * Survivor
  - 比例越大，Eden 区越大，Survivor 区越小
  - 影响 Minor GC 后对象的存活和晋升老年代的速度

---

## 总结对比

| 参数 | 调控对象 | 含义 | 影响 |
|------|----------|------|------|
| `-Xms` | 堆 | 初始堆大小 | JVM 启动内存分配 |
| `-Xmx` | 堆 | 最大堆大小 | 堆内存上限，防止 OOM |
| `-Xmn` | 新生代 | 新生代大小 | 控制 Minor GC 次数和新生代空间 |
| `-XX:SurvivorRatio` | 新生代 | Eden / Survivor 比例 | 控制对象在 Survivor 区的存活和晋升老年代的速度 |

