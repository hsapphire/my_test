
1. Kafka 的生产端如何确保消息可靠发送，且避免因“未收到回执”导致重复发送。
这是典型的“消息发送可靠性（生产端幂等性）”问题。
你调用 Kafka producer 发送一条消息；

网络闪断或响应超时，Kafka producer 没有收到 ack 回执；

你不确定消息是否已发送成功，于是你可能 重发；

这可能导致 Kafka 收到 重复的消息。

from confluent_kafka import Producer

conf = {
    'bootstrap.servers': 'localhost:9092',
    'enable.idempotence': True,             # ✅ 开启幂等性
    'acks': 'all',                          # ✅ 所有副本确认后才算成功
    'retries': 5,                           # ✅ 自动重试
    'linger.ms': 5,                         # 小延迟批量发送
    'batch.size': 16384
}

p = Producer(conf)

p.produce('my-topic', key='user1', value='event1')
p.flush()

Kafka 幂等 Producer 使用内部的：

Producer ID（PID）

每个 Partition 的 Sequence Number

从而让 Kafka Broker 即使多次接收消息，也只保存一次，实现 “一次且仅一次”的发送语义。

回调确认机制（可做精确确认）
你还可以加上“回调函数”，在收到 Kafka 的 ack 回执时处理业务逻辑：

def delivery_report(err, msg):
    if err is not None:
        print(f"❌ 消息发送失败: {err}")
        # 可以记录失败消息、告警、重试队列等
    else:
        print(f"✅ 消息发送成功: {msg.key()}: {msg.value()}")

p.produce('my-topic', key='user1', value='event1', callback=delivery_report)
p.flush()

